<!DOCTYPE html>
<html>
<head>
    <script src="https://res.cdn.office.net/teams-js/2.2.0/js/MicrosoftTeams.min.js" 
      integrity="sha384yBjE++eHeBPzIg+IKl9OHFqMbSdrzY2S/LW3qeitc5vqXewEYRWegByWzBN/chRh" 
      crossorigin="anonymous">
    </script>
</head>
<body>
    <button onclick="selectGray()">Select Personal</button>
    <button onclick="selectRed()">Select Datadog</button>
    <button onclick="navigateToPostsTab()">Back</button> <!-- Updated back button -->

    <label for="numberSelect">Severity:</label>
    <select id="numberSelect" name="numberSelect">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
    </select>

    <iframe src="https://dd.datad0g.com/graph/embed?token=dc56971eb4ec414570663092e3166c11020a7f13adc0f64c5b1ad825dcd359f9&height=300&width=600&legend=true" width="600" height="300" frameborder="0"></iframe>

    <script>
        // Initialize the Microsoft Teams SDK
        microsoftTeams.app.initialize().then(() => {
            console.log("Microsoft Teams SDK initialized");
            authenticateUser();
        }).catch((error) => {
            console.error("Error initializing Microsoft Teams SDK:", error);
        });

        // Function to save the gray configuration
        let saveGray = () => {
            microsoftTeams.pages.config.registerOnSaveHandler((saveEvent) => {
                const configPromise = microsoftTeams.pages.config.setConfig({
                    websiteUrl: "https://valerie-is-amazing2.github.io/teams-app-config/",
                    contentUrl: "https://valerie-is-amazing2.github.io/teams-app-config/",
                    entityId: "grayIconTab",
                    suggestedDisplayName: "Personal Tab"
                });
                configPromise
                    .then((result) => { saveEvent.notifySuccess(); })
                    .catch((error) => { saveEvent.notifyFailure("failure message"); });
            });
        };

        // Function to save the red configuration
        let saveRed = () => {
            microsoftTeams.pages.config.registerOnSaveHandler((saveEvent) => {
                const configPromise = microsoftTeams.pages.config.setConfig({
                    websiteUrl: "https://app.datad0g.com/ms_teams/config",
                    contentUrl: "https://app.datad0g.com/ms_teams/config",
                    entityId: "redIconTab",
                    suggestedDisplayName: "Datadog Tab"
                });
                configPromise
                    .then((result) => { saveEvent.notifySuccess(); })
                    .catch((error) => { saveEvent.notifyFailure("failure message"); });
            });
        };

        // Function to handle the selection of the gray option
        const selectGray = () => {
            microsoftTeams.pages.config.setValidityState(true);
            saveGray();
        };

        // Function to handle the selection of the red option
        const selectRed = () => {
            microsoftTeams.pages.config.setValidityState(true);
            saveRed();
        };

        // Navigate to the "Posts" tab and send an Adaptive Card to the channel
        const navigateToPostsTab = () => {
            microsoftTeams.getContext((context) => {
                const channelId = context.channelId;
                const teamId = context.teamId;
                const tenantId = context.tid; // Tenant ID

                const postsTabUrl = `https://teams.microsoft.com/l/channel/${channelId}/General?groupId=${teamId}&tenantId=${tenantId}`;
                console.log("Constructed postsTabUrl:", postsTabUrl);

                microsoftTeams.executeDeepLink(postsTabUrl);
                console.log("Attempted to navigate to the Posts tab.");
                sendAdaptiveCard(channelId, teamId, tenantId, context.entityId);
            });
        };

        // Function to send an Adaptive Card with a deep link button
        const sendAdaptiveCard = (channelId, teamId, tenantId, entityId) => {
            const tabUrl = `https://teams.microsoft.com/l/entity/${entityId}/${channelId}?groupId=${teamId}&tenantId=${tenantId}`;
            console.log("AdaptiveTabUrl:", tabUrl);
            const card = {
                "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                "type": "AdaptiveCard",
                "version": "1.2",
                "body": [
                    {
                        "type": "TextBlock",
                        "text": "You pressed back to posts tab! Click the button to go back to the tab.",
                        "weight": "Bolder",
                        "size": "Medium"
                    },
                    {
                        "type": "ActionSet",
                        "actions": [
                            {
                                "type": "Action.OpenUrl",
                                "title": "View Tab",
                                "url": tabUrl
                            }
                        ]
                    }
                ]
            };

            const messagePayload = {
                body: {
                    contentType: "application/vnd.microsoft.card.adaptive",
                    content: card
                }
            };

            microsoftTeams.teams.sendMessageToChannel({
                teamId: teamId,
                channelId: channelId,
                message: messagePayload
            }).then((result) => {
                console.log("Adaptive Card posted to the channel successfully.");
            }).catch((error) => {
                console.error("Error posting Adaptive Card to the channel:", error);
            });
        };
    </script>
</body>
</html>